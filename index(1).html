<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Politische Großmächte Karte mit News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
    }
    .country-highlight {
      fill: red !important;
      fill-opacity: 0.5 !important;
      stroke: darkred !important;
      stroke-width: 2 !important;
      cursor: pointer;
    }
    .connection-line {
      stroke: blue;
      stroke-width: 3;
      cursor: pointer;
    }
    #newsPopup {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 10px;
      display: none;
      z-index: 10000;
    }
    #newsPopup h3 {
      margin-top: 0;
    }
    #newsPopup button.close-btn {
      position: absolute;
      top: 5px;
      right: 8px;
      background: #c33;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      padding: 2px 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="newsPopup">
    <button class="close-btn" onclick="closeNews()">✖</button>
    <h3>News</h3>
    <div id="newsContent">Lade News...</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geojson-svg@1.0.0/leaflet-geojson-svg.min.js"></script>
  <script>
    // API URL deiner Vercel-Instanz
    const API_URL = "https://news-q46nktudy-lukas-projects-c3a3d4d3.vercel.app/api/news?q=";

    const map = L.map("map").setView([20, 0], 2);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap-Mitwirkende",
    }).addTo(map);

    // Beispiel Großmächte mit Konflikten
    // Format: landCode, landName, [array von Konfliktpartnern mit {code, name, topics}]
    const countries = [
      {
        code: "USA",
        name: "USA",
        latlng: [38, -97],
        conflicts: [
          {
            code: "CHN",
            name: "China",
            topics: [
              "Politischer Konflikt",
              "Handelsstreit",
              "Technologie-Wettbewerb",
            ],
          },
          {
            code: "RUS",
            name: "Russland",
            topics: [
              "Sicherheitskonflikt",
              "Militärische Spannungen",
              "Geopolitische Interessen",
            ],
          },
        ],
      },
      {
        code: "CHN",
        name: "China",
        latlng: [35, 105],
        conflicts: [
          {
            code: "USA",
            name: "USA",
            topics: [
              "Politischer Konflikt",
              "Handelsstreit",
              "Technologie-Wettbewerb",
            ],
          },
          {
            code: "IND",
            name: "Indien",
            topics: [
              "Grenzstreitigkeiten",
              "Regionale Machtbalance",
              "Politische Spannungen",
            ],
          },
        ],
      },
      {
        code: "RUS",
        name: "Russland",
        latlng: [61, 105],
        conflicts: [
          {
            code: "USA",
            name: "USA",
            topics: [
              "Sicherheitskonflikt",
              "Militärische Spannungen",
              "Geopolitische Interessen",
            ],
          },
          {
            code: "UKR",
            name: "Ukraine",
            topics: ["Krieg", "Territoriale Integrität", "Internationale Reaktionen"],
          },
        ],
      },
      // Weitere Großmächte hier ergänzen ...
    ];

    // Länder-Circle Layer
    const countryLayers = {};

    // Marker & Linien Layer
    const connectionLines = [];

    // Land-Fläche als rotes Polygon (vereinfacht mit CircleMarker)
    countries.forEach((country) => {
      const circle = L.circleMarker(country.latlng, {
        radius: 30,
        color: "red",
        fillColor: "red",
        fillOpacity: 0.3,
        weight: 2,
      })
        .addTo(map)
        .bindTooltip(country.name, { permanent: true, direction: "center" })
        .on("click", () => onCountryClick(country));
      countryLayers[country.code] = circle;
    });

    // Klick auf Land zeigt Konflikt-Linien
    function onCountryClick(country) {
      // Alle Linien entfernen
      connectionLines.forEach((line) => map.removeLayer(line));
      connectionLines.length = 0;

      // Für jeden Konfliktpartner Linie zeichnen
      country.conflicts.forEach((conflict) => {
        const partner = countries.find((c) => c.code === conflict.code);
        if (!partner) return;

        const line = L.polyline([country.latlng, partner.latlng], {
          color: "blue",
          weight: 3,
          opacity: 0.7,
          interactive: true,
        }).addTo(map);

        line.on("click", (e) => {
          e.originalEvent.stopPropagation(); // Verhindert Karten-Klick
          fetchNewsForConflict(country.name, partner.name);
        });

        connectionLines.push(line);
      });
    }

    // News Popup close Funktion
    function closeNews() {
      const popup = document.getElementById("newsPopup");
      popup.style.display = "none";
    }

    // News von API laden
    async function fetchNewsForConflict(country1, country2) {
      const popup = document.getElementById("newsPopup");
      const content = document.getElementById("newsContent");
      content.innerHTML = "Lade News...";
      popup.style.display = "block";

      try {
        // Query für beide Länder zusammensetzen
        const query = encodeURIComponent(`${country1} ${country2} Konflikt`);
        const response = await fetch(API_URL + query);
        if (!response.ok) throw new Error("API Fehler");
        const data = await response.json();

        if (data.articles && data.articles.length > 0) {
          content.innerHTML = "";
          data.articles.forEach((article) => {
            const a = document.createElement("a");
            a.href = article.url;
            a.target = "_blank";
            a.textContent = article.title;
            a.style.display = "block";
            a.style.marginBottom = "8px";
            content.appendChild(a);
          });
        } else {
          content.innerHTML = "Keine aktuellen News gefunden.";
        }
      } catch (err) {
        content.innerHTML = "Fehler beim Laden der News.";
        console.error(err);
      }
    }
  </script>
</body>
</html>
